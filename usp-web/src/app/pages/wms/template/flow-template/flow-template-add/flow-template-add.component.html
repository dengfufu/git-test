<nz-page-header nzBackIcon>
  <nz-page-header-title>流程模板添加</nz-page-header-title>
  <nz-page-header-extra>
    <button nz-button (click)="goBack()">返回</button>
    <button nz-button nzType="primary" (click)="addSubmit()">提交</button>
  </nz-page-header-extra>
</nz-page-header>
<nz-layout>
  <div nz-row class="layout-row">
    <div nz-col class="layout-col" nzSpan="6">
      <nz-card [nzBordered]="false">
        <div class="div-row" nz-row>
          <div nz-col class="label-item" nzSpan="10">模板名称：</div>
          <div nz-col nzSpan="14">{{ flowTemplate.name }}</div>
        </div>
        <div class="div-row" nz-row>
          <div nz-col class="label-item" nzSpan="10">流程类型：</div>
          <div nz-col nzSpan="14">{{ flowTemplate.largeClassName }}--{{ flowTemplate.smallClassName }}</div>
        </div>
        <div class="div-row" nz-row>
          <div nz-col class="label-item" nzSpan="10">顺序号：</div>
          <div nz-col nzSpan="14">{{ flowTemplate.sortNo }}</div>
        </div>
        <div class="div-row" nz-row>
          <div nz-col class="label-item" nzSpan="10">是否可用：</div>
          <div nz-col nzSpan="14">{{ flowTemplate.enabled }}</div>
        </div>
        <div class="div-row" nz-row>
          <div nz-col class="label-item" nzSpan="10">描述：</div>
          <div nz-col nzSpan="14">{{ flowTemplate.description }}</div>
        </div>
      </nz-card>
      <div class="div-row" nz-row style="bottom: 10px;right: 30px;position: absolute;">
        <button nz-button nzType="primary" nzSize="small" nzShape="round" (click)="editFlowType()">编辑</button>
      </div>
    </div>
    <div nz-col class="layout-col" nzSpan="18">
      <nz-card style="border-width: 0 0 0 1px">
        <div nz-row>
          <div nz-col nzSpan="12">
            <form [formGroup]="addDetailForm">
              <nz-form-item>
                <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired>节点类型</nz-form-label>
                <nz-form-control [nzSm]="14" [nzXs]="24" [nzErrorTip]="">
                  <nz-select nzShowSearch nzAllowClear formControlName="nodeType" nzPlaceHolder="请选择节点类型">
                    <nz-option *ngFor="let nodeType of selectOptions.nodeTypeList" [nzValue]="nodeType.id"
                               [nzLabel]="nodeType.name"></nz-option>
                  </nz-select>
                </nz-form-control>
              </nz-form-item>
              <nz-form-item>
                <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired>节点名称</nz-form-label>
                <nz-form-control [nzSm]="14" [nzXs]="24">
                  <input nz-input formControlName="name" placeHolder="请输入节点名称"/>
                </nz-form-control>
              </nz-form-item>
              <nz-form-item>
                <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired>基本信息模板</nz-form-label>
                <nz-form-control [nzSm]="14" [nzXs]="24">
                  <nz-select nzShowSearch nzAllowClear formControlName="formMainId" nzPlaceHolder="请选择基本信息模板">
                    <nz-option *ngFor="let formMain of selectOptions.formMainList" [nzValue]="formMain.value"
                               [nzLabel]="formMain.text"></nz-option>
                  </nz-select>
                </nz-form-control>
              </nz-form-item>
              <nz-form-item>
                <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired>明细信息模板</nz-form-label>
                <nz-form-control [nzSm]="14" [nzXs]="24">
                  <nz-select nzShowSearch nzAllowClear formControlName="formDetailId" nzPlaceHolder="请选择明细信息模板">
                    <nz-option *ngFor="let formDetail of selectOptions.formDetailList" [nzValue]="formDetail.value"
                               [nzLabel]="formDetail.text"></nz-option>
                  </nz-select>
                </nz-form-control>
              </nz-form-item>
              <nz-form-item>
                <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired>节点顺序</nz-form-label>
                <nz-form-control [nzSm]="14" [nzXs]="24">
                  <nz-input-number
                    [nzMin]="1"
                    [nzMax]="1000000"
                    [nzStep]="1"
                    formControlName="sortNo"
                  ></nz-input-number>
                </nz-form-control>
              </nz-form-item>
              <!--<nz-form-item>
                <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired>是否核心节点</nz-form-label>
                <nz-form-control [nzSm]="14" [nzXs]="24">
                  <nz-radio-group formControlName="isCore">
                    <label nz-radio nzValue="Y">是</label>
                    <label nz-radio nzValue="N">否</label>
                  </nz-radio-group>
                </nz-form-control>
              </nz-form-item>-->
              <nz-form-item>
                <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired>处理人</nz-form-label>
                <nz-form-control [nzSm]="14" [nzXs]="24" nzHasFeedback>
                  <input nz-input formControlName="handler" placeholder="请选择处理人" readonly/>
                </nz-form-control>
              </nz-form-item>
            </form>
          </div>
          <div nz-col nzSpan="12">
            <div>
              <div nz-row nzType="flex" nzAlign="middle" style="height: 40px">
                <label style="font-size: 14px;font-weight: bolder;color: rgba(0, 0, 0, 0.85)">处理人: </label>
              </div>
              <form [formGroup]="handlerForm">
                <nz-form-item>
                  <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired>处理人类型</nz-form-label>
                  <nz-form-control [nzSm]="14" [nzXs]="24" [nzErrorTip]="">
                    <nz-select nzShowSearch nzAllowClear formControlName="handlerTypeId" nzPlaceHolder="请选择处理人类型"
                               (ngModelChange)="changeHandlerType($event)">
                      <nz-option *ngFor="let nodeType of selectOptions.handlerTypeList" [nzValue]="nodeType.id"
                                 [nzLabel]="nodeType.name"></nz-option>
                    </nz-select>
                  </nz-form-control>
                </nz-form-item>
                <nz-form-item>
                  <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired>{{text}}</nz-form-label>
                  <nz-form-control [nzSm]="14" [nzXs]="24" [nzErrorTip]="">
                    <nz-select nzShowSearch nzAllowClear formControlName="handlerId" nzPlaceHolder="{{text}}"
                               [nzDisabled]="this.flag">
                      <nz-option *ngFor="let nodeType of selectOptions.textList" [nzValue]="nodeType.id"
                                 [nzLabel]="nodeType.name"></nz-option>
                    </nz-select>
                  </nz-form-control>
                </nz-form-item>
                <nz-form-item>
                  <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired>是否主处理人</nz-form-label>
                  <nz-form-control [nzSm]="14" [nzXs]="24">
                    <nz-radio-group formControlName="isMainDirector" [nzDisabled]="this.flag">
                      <label nz-radio nzValue="Y">是</label>
                      <label nz-radio nzValue="N">否</label>
                    </nz-radio-group>
                  </nz-form-control>
                </nz-form-item>
              </form>
            </div>
          </div>
        </div>
        <div nz-row class="div-row" nzAlign="bottom">
          <button nz-button style="margin:10px 30px 0 0" nzSize="small" nzShape="round" (click)="addHandler(handlerForm.controls.handlerId.value)"
                  [disabled]="this.flag||!handlerForm.valid">添加处理人</button>
          <button nz-button nzType="primary" [disabled]="!addDetailForm.valid"
                  style="margin:10px 30px 0 0" nzSize="small" nzShape="round" (click)="addNode()">加入列表</button>
          <button nz-button style="margin:10px 30px 0 0" nzSize="small" nzShape="round" (click)="clearDetailForm()">清空</button>
        </div>
      </nz-card>
    </div>
  </div>
  <div nz-row>
    <nz-card style="border-width: 1px 0 0 0">
      <p class="p-title">流程步骤</p>
      <nz-table
        nzBordered
        nzHideOnSinglePage
        nzFrontPagination="true"
        nzShowSizeChanger
        [nzData]="flowNodeList"
        nzLoadingDelay="100"
        nzNoResult="无"
      >
        <thead>
        <tr>
          <th nzWidth="50px">序号</th>
          <th>节点名称</th>
          <th>基本信息模板</th>
          <th>明细信息模板</th>
          <th>节点类型</th>
          <th>处理人</th>
          <th>是否可用</th>
          <th>是否核心节点</th>
          <th>节点顺序号</th>
          <th>操作</th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let data of flowNodeList; let index = index">
          <td nzAlign="center">{{ index +1 }}</td>
          <td nzAlign="left">{{ data.name }}</td>
          <td nzAlign="left" >{{ mapOfMain[data.formMainId] }}</td>
          <td nzAlign="left" >{{ mapOfDetail[data.formDetailId] }}</td>

          <!--<td *ngIf="data.nodeType * 1 === 10" > 填写节点</td>-->
          <td *ngIf="data.nodeType === 10" > 填写节点</td>
          <td *ngIf="data.nodeType === 20"> 普通审批节点</td>
          <td *ngIf="data.nodeType === 30"> 会签审批节点</td>
          <td *ngIf="data.nodeType === 40"> 发货节点</td>
          <td *ngIf="data.nodeType === 50"> 收货节点</td>
          <td *ngIf="data.nodeType === 60"> 确认节点</td>
          <td > {{ data.handler }}</td>
          <td > {{ data.enabled }}</td>
          <td > {{ data.isCore }}</td>
          <td > {{ data.sortNo }}</td>
          <td nzAlign="center">
            <a (click)="editHandler(data, index)">
              <i nz-icon nzType="edit" nzTheme="fill"></i>编辑处理人
            </a>
            <nz-divider nzType="vertical"></nz-divider>
            <a (click)="editFlowNode(data, index)">
              <i nz-icon nzType="edit" nzTheme="fill"></i>编辑
            </a>
            <nz-divider nzType="vertical"></nz-divider>
            <a (click)="delFlowNodeConfirm(index)">
              <i nz-icon nzType="delete" nzTheme="fill"></i>删除
            </a>
            <nz-divider nzType="vertical"></nz-divider>
            <a (click)="swithFlowNode(data, index)">
              <i nz-icon nzType="copy" nzTheme="fill"></i>开关
            </a>
          </td>
        </tr>
        </tbody>
      </nz-table>
    </nz-card>
  </div>
</nz-layout>
