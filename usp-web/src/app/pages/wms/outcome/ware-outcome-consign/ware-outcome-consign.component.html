<nz-page-header nzBackIcon>
  <nz-page-header-title>出库发货</nz-page-header-title>
  <nz-page-header-extra>
    <button nz-button nzType="primary" (click)="goBack()">返回</button>
    <button nz-button nzType="primary">保存</button>
    <button nz-button nzType="primary" (click)="addSubmit()">提交</button>
  </nz-page-header-extra>
</nz-page-header>
<nz-layout>
  <nz-card style="border-width: 0 0 0 1px">
    <form [formGroup]="addDetailForm">
      <div nz-row>
        <div nz-col nzSpan="12">
          <nz-form-item>
            <nz-form-label nzSpan="4" nzRequired>发货人</nz-form-label>
            <nz-form-control nzSpan="6">
              <nz-select nzShowSearch nzAllowClear nzPlaceHolder="请选择发货人" formControlName="consignBy"
                         (ngModelChange)="consignByChange($event)">
                <nz-option *ngFor="let option of wmsService.selectOptions.userList " [nzValue]="option.userId"
                           (nzOnSearch)="wmsService.queryUserList($event)"
                           [nzLabel]="option.userName"></nz-option>
              </nz-select>
            </nz-form-control>
            <nz-form-control nzSpan="10">
              <input nz-input nzSize="default" formControlName="consignMobile" placeholder="请输入联系方式"/>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col nzSpan="12">
          <nz-form-item>
            <nz-form-label nzSpan="4">收货人</nz-form-label>
            <nz-form-control nzSpan="6">

              <input
                placeholder="请输入或选择收货人"
                nz-input
                formControlName="receiveName"
                [nzAutocomplete]="auto"
                (ngModelChange)="changeReceiveInfo(this.addDetailForm.controls.receiveName.value)"
              />
              <nz-autocomplete #auto>
                <nz-auto-option *ngFor="let option of wmsService.selectOptions.userList" [nzValue]="option.userId" >{{ option.userName }}</nz-auto-option>
              </nz-autocomplete>
            </nz-form-control>
            <nz-form-control nzSpan="10">
              <input nz-input nzSize="default" formControlName="receiverMobile" placeholder="请输入联系方式"/>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>
      <div nz-row>
        <div nz-col nzSpan="24">
          <nz-form-item>
            <nz-form-label nzSpan="2" nzRequired>收货地址</nz-form-label>
            <nz-form-control nzSpan="4">
              <nz-cascader
                nzPlaceHolder="请选择收货地址"
                [nzChangeOnSelect]="true"
                [nzAllowClear]="true"
                formControlName="area"
                (ngModelChange)="areaChange($event)"
                [nzOptions]="this.wmsService.selectOptions.areaInfoList">
              </nz-cascader>
            </nz-form-control>
            <nz-form-control nzSpan="6">
              <input nz-input formControlName="receiveAddress" nzSize="default" placeholder="请输入详细地址"/>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>
      <div nz-row>
        <div nz-col nzSpan="12">
          <nz-form-item>
            <nz-form-label nzSpan="4" nzRequired>运送方式</nz-form-label>
            <nz-form-control nzSpan="10">
              <nz-radio-group formControlName="transportTypeId" [(ngModel)]="transportType">
                <label nz-radio [nzValue]="option.id"
                       *ngFor="let option of wmsService.selectOptions.transportTypeList">{{ option.name }}</label>
              </nz-radio-group>
            </nz-form-control>
            <nz-form-label nzSpan="4" nzRequired>总箱数</nz-form-label>
            <nz-form-control nzSpan="4">
              <nz-input-number nzSize="default" formControlName="totalBoxNum" [nzMin]="1" [nzStep]="1"></nz-input-number>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col nzSpan="12" *ngIf="transportType == 20">
          <nz-form-item>
            <nz-form-label nzSpan="4" nzRequired>托运方式</nz-form-label>
            <nz-form-control nzSpan="10">
              <nz-select nzShowSearch nzAllowClear nzPlaceHolder="请选择托运方式" formControlName="consignTypeId">
                <nz-option *ngFor="let option of wmsService.selectOptions.cosignTypeList " [nzValue]="option.id"
                           [nzLabel]="option.name"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col nzSpan="12" *ngIf="transportType == 30">
          <nz-form-item>
            <nz-form-label nzSpan="4" nzRequired>快递类型</nz-form-label>
            <nz-form-control nzSpan="10">
              <nz-select nzShowSearch nzAllowClear nzPlaceHolder="请选择快递类型" formControlName="expressType">
                <nz-option *ngFor="let option of wmsService.selectOptions.expressTypeList " [nzValue]="option.id"
                           [nzLabel]="option.name"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>
      <div nz-row *ngIf="transportType == 30">
        <div nz-col nzSpan="12">
          <nz-form-item>
            <nz-form-label nzSpan="4" nzRequired>快递公司</nz-form-label>
            <nz-form-control nzSpan="10">
              <nz-select nzShowSearch nzAllowClear nzPlaceHolder="请选择快递公司" formControlName="expressCorpId">
                <nz-option *ngFor="let option of wmsService.selectOptions.expressCorpList " [nzValue]="option.id"
                           [nzLabel]="option.name"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col nzSpan="12">
          <nz-form-item>
            <nz-form-label nzSpan="4">快递单号</nz-form-label>
            <nz-form-control nzSpan="10">
              <input nz-input nzSize="default" formControlName="expressNo" placeholder="请输入快递单号"/>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>
      <div nz-row>
        <div nz-col nzSpan="24">
          <nz-form-item>
            <nz-form-label nzSpan="2">备注</nz-form-label>
            <nz-form-control nzSpan="10">
              <textarea rows="1" nz-input placeholder="请输入100字以内的出库描述" formControlName="description" maxlength="100"></textarea>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>
    </form>
  </nz-card>
  <nz-card style="border-width: 1px 0 0 0">
    <p class="p-title">
      发货列表
      <i nz-icon nzType="wms:add-circle" nzTheme="outline" class="i-add" nz-tooltip nzTooltipTitle="添加备件"
         (click)="addPartList()"></i>
    </p>
    <nz-table
      nzBordered
      nzShowPagination="false"
      [nzData]="partList">
      <thead>
      <tr>
        <th nzWidth="50px">序号</th>
        <th>申请单号</th>
        <th>出库地点</th>
        <th>申请人</th>
        <th>出库类别</th>
        <th>申请时间</th>
        <th>物料分类</th>
        <th>物料型号</th>
        <th>物料规格</th>
        <th>物料状态</th>
        <th>唯一编码</th>
        <th>数量</th>
        <th>分箱号</th>
        <th>操作</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let data of partList; let index = index">
        <td>{{page.getNo(index)}}</td>
        <td>{{data.outcomeCode}}</td>
        <td>{{data.depotName}}</td>
        <td>{{data.createNameBy}}</td>
        <td>{{data.smallClassName}}</td>
        <td>{{data.createTime | date: 'yyyy-MM-dd HH:mm:ss'}}</td>
        <td>{{data.catalogName}}</td>
        <td>{{data.modelName}}</td>
        <td>{{data.normsValue}}</td>
        <td>{{data.statusName}}</td>
        <td>{{data.barcode}}</td>
        <td *ngIf="flag.edit !== page.getNo(index) ">{{ data.quantity }}</td>
        <td *ngIf="flag.edit === page.getNo(index)">
          <nz-input-number nzSize="small" [(ngModel)]="data.quantity" [nzMin]="1" [nzMax]="data.sum"
                           [nzStep]="1"></nz-input-number>
          <span class="prompt"><={{data.sum}}</span>
        </td>
        <td>{{data.subBoxNum}}</td>
        <td>
          <i *ngIf="flag.edit !== page.getNo(index)" nz-icon nzType="form" nzTheme="outline" nz-tooltip
             nzTooltipTitle="修改记录" style="color: #FF9F00;font-size: 17px;"
             (click)="editPart( page.getNo(index))"></i>
          <i *ngIf="flag.edit === page.getNo(index)" nz-icon nzType="save" nzTheme="outline" nz-tooltip
             nzTooltipTitle="保存修改" style="color: #FF9F00;font-size: 17px;"
             (click)="editPart(0);"></i>
          &nbsp;&nbsp;&nbsp;&nbsp;
          <i nz-icon nzType="wms:close-circle" nzTheme="outline" style="font-size: 17px;" nz-tooltip
             nzTooltipTitle="删除记录" (click)="deletePart(data.id,data.subBoxNum);"></i>
        </td>
      </tr>
      <tr *ngIf="total > 0">
        <td colspan="11">合计</td>
        <td>{{total}}</td>
      </tr>
      </tbody>
    </nz-table>
  </nz-card>
</nz-layout>
